name: Test pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.sha }}
  cancel-in-progress: true

jobs:
    test:
        name: 'Tests'
        runs-on: 'ubuntu-latest'
        steps:
            - name: Check out code into the Go module directory
              uses: actions/checkout@v3

            - name: Set up Go
              uses: actions/setup-go@v4
              with:
                go-version-file: 'go.mod'
                cache-dependency-path: 'go.sum'

            - name: golangci-lint
              uses: golangci/golangci-lint-action@v3
              with:
                # Optional: version of golangci-lint to use in form of v1.2 or v1.2.3 or `latest` to use the latest version
                version: v1.54.1
                # Optional: golangci-lint command line arguments.
                args: --verbose
                # Optional: if set to true then the all caching functionality will be complete disabled,
                #           takes precedence over all other caching options.
                skip-cache: true

            - name: modVerify
              run: go mod verify

            - name: modTidy
              run: make tools-tidy

            - name: ensure compilation
              run: go build

            - name: go test
              timeout-minutes: 30
              run: |
                go test -v -count=1 ./...
